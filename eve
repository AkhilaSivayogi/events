program.cs:

using Backend.Data;
using Backend.Services;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);
var config = builder.Configuration;
var services = builder.Services;

// --- Add EF Core (SQL Server example) ---
services.AddDbContext<AppDbContext>(options =>
    options.UseSqlServer(config.GetConnectionString("DefaultConnection")));

// --- CORS: allow React dev server (change to production origin for deploy) ---
services.AddCors(options =>
{
    options.AddPolicy("AllowReactDev", policy =>
    {
        policy.WithOrigins("http://localhost:3000") // frontend origin (development)
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});

// --- Add controllers ---
services.AddControllers();

// --- Configure JWT authentication ---
var jwtKey = config["Jwt:Key"];
var jwtIssuer = config["Jwt:Issuer"];
var jwtAudience = config["Jwt:Audience"];
if (string.IsNullOrEmpty(jwtKey))
{
    throw new Exception("Jwt:Key is not configured. Set it in appsettings.json or environment.");
}

services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.RequireHttpsMetadata = true;
    options.SaveToken = true;
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtKey)),
        ValidateIssuer = true,
        ValidIssuer = jwtIssuer,
        ValidateAudience = true,
        ValidAudience = jwtAudience,
        ValidateLifetime = true,
        ClockSkew = TimeSpan.FromMinutes(2)
    };
});

// --- DI: application services ---
services.AddScoped<ITokenService, TokenService>();
services.AddScoped<IAuthService, AuthService>();

// optional: swagger for debugging
services.AddEndpointsApiExplorer();
services.AddSwaggerGen();

var app = builder.Build();

// --- Middleware pipeline (order matters) ---
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

// Note: Call UseCors before UseAuthentication/UseAuthorization if you need CORS on auth endpoints
app.UseCors("AllowReactDev");

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();

-------------------------------------------------------------------------------------------------------------------
appdbcontext.cs:

using Backend.Models;
using Microsoft.EntityFrameworkCore;

namespace Backend.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> opts) : base(opts) { }

        public DbSet<User> Users { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.Entity<User>()
                .HasIndex(u => u.Email)
                .IsUnique();

            base.OnModelCreating(modelBuilder);
        }
    }
}
--------------------------------------------------------------------
models uses.cs


using System.ComponentModel.DataAnnotations;

namespace Backend.Models
{
    public class User
    {
        public int Id { get; set; }

        [Required, MaxLength(150)]
        public string FullName { get; set; }

        [Required, MaxLength(80)]
        public string Role { get; set; }

        [Required, MaxLength(200)]
        public string Email { get; set; }

        [Required]
        public string PasswordHash { get; set; }

        public string Phone { get; set; }
        public string Address { get; set; }
    }
}
--------------------------------------------------------------------------------------------
dto authdto.cs:

namespace Backend.DTOs
{
    public class RegisterDto
    {
        public string FullName { get; set; }
        public string Role { get; set; }
        public string Email { get; set; }
        public string Password { get; set; }
        public string Phone { get; set; }
        public string Address { get; set; }
    }

    public class LoginDto
    {
        public string Email { get; set; }
        public string Password { get; set; }
    }

    public class AuthResponseDto
    {
        public string Token { get; set; }
        public DateTime Expires { get; set; }
        public object User { get; set; } // id, fullName, role, email
    }
}
--------------------------------------------------------------------------------------------------------------
Services: ITokenService + TokenService
using Backend.Models;

namespace Backend.Services
{
    public interface ITokenService
    {
        string CreateToken(User user);
    }
}


using Backend.Models;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace Backend.Services
{
    public class TokenService : ITokenService
    {
        private readonly IConfiguration _config;
        public TokenService(IConfiguration config) => _config = config;

        public string CreateToken(User user)
        {
            var key = _config["Jwt:Key"];
            var issuer = _config["Jwt:Issuer"];
            var audience = _config["Jwt:Audience"];
            var expiryMinutes = int.TryParse(_config["Jwt:DurationInMinutes"], out var m) ? m : 60;

            var claims = new[]
            {
                new Claim(JwtRegisteredClaimNames.Sub, user.Email),
                new Claim("id", user.Id.ToString()),
                new Claim("role", user.Role ?? ""),
                new Claim("name", user.FullName ?? "")
            };

            var symmetricKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(key));
            var creds = new SigningCredentials(symmetricKey, SecurityAlgorithms.HmacSha256);
            var expires = DateTime.UtcNow.AddMinutes(expiryMinutes);

            var token = new JwtSecurityToken(
                issuer: issuer,
                audience: audience,
                claims: claims,
                expires: expires,
                signingCredentials: creds);

            return new JwtSecurityTokenHandler().WriteToken(token);
        }
    }
}
---------------------------------------------------------------------------------------------------
Services: IAuthService + AuthService

using Backend.DTOs;
using Backend.Models;

namespace Backend.Services
{
    public interface IAuthService
    {
        Task<(bool Success, string Error)> RegisterAsync(RegisterDto dto);
        Task<(bool Success, AuthResponseDto Response, string Error)> LoginAsync(LoginDto dto);
    }
}



using Backend.Data;
using Backend.DTOs;
using Backend.Models;
using Microsoft.EntityFrameworkCore;

namespace Backend.Services
{
    public class AuthService : IAuthService
    {
        private readonly AppDbContext _db;
        private readonly ITokenService _tokenService;

        public AuthService(AppDbContext db, ITokenService tokenService)
        {
            _db = db;
            _tokenService = tokenService;
        }

        public async Task<(bool Success, string Error)> RegisterAsync(RegisterDto dto)
        {
            var email = dto.Email?.Trim().ToLower();
            if (string.IsNullOrEmpty(email) || !new System.ComponentModel.DataAnnotations.EmailAddressAttribute().IsValid(email))
                return (false, "Invalid email");

            if (string.IsNullOrEmpty(dto.Password) || dto.Password.Length < 6)
                return (false, "Password must be at least 6 characters");

            var exists = await _db.Users.AnyAsync(u => u.Email == email);
            if (exists) return (false, "Email already registered");

            var user = new User
            {
                FullName = dto.FullName,
                Role = dto.Role,
                Email = email,
                PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password),
                Phone = dto.Phone,
                Address = dto.Address
            };

            _db.Users.Add(user);
            await _db.SaveChangesAsync();
            return (true, null);
        }

        public async Task<(bool Success, AuthResponseDto Response, string Error)> LoginAsync(LoginDto dto)
        {
            var email = dto.Email?.Trim().ToLower();
            var user = await _db.Users.FirstOrDefaultAsync(u => u.Email == email);
            if (user == null) return (false, null, "Invalid credentials");

            var verified = BCrypt.Net.BCrypt.Verify(dto.Password, user.PasswordHash);
            if (!verified) return (false, null, "Invalid credentials");

            var token = _tokenService.CreateToken(user);
            var response = new AuthResponseDto
            {
                Token = token,
                Expires = DateTime.UtcNow.AddMinutes(int.TryParse(_db.Database.GetDbConnection().Database, out _) ? 60 : 60), // placeholder, use config in tokenservice if needed
                User = new { user.Id, user.FullName, user.Role, user.Email }
            };

            return (true, response, null);
        }
    }
}
-----------------------------------------------------------------------------------------------------------
Controller: UsersController (Auth endpoints)

using Backend.DTOs;
using Backend.Services;
using Microsoft.AspNetCore.Mvc;

namespace Backend.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class UsersController : ControllerBase
    {
        private readonly IAuthService _auth;

        public UsersController(IAuthService auth) => _auth = auth;

        [HttpPost("register")]
        public async Task<IActionResult> Register([FromBody] RegisterDto dto)
        {
            var (success, error) = await _auth.RegisterAsync(dto);
            if (!success) return BadRequest(new { message = error });
            return Created(string.Empty, new { message = "User registered" });
        }

        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginDto dto)
        {
            var (success, resp, error) = await _auth.LoginAsync(dto);
            if (!success) return Unauthorized(new { message = error });
            return Ok(resp); // { token, expires, user }
        }
    }
}
------------------------------------------------------------------------
Migrations & Database
dotnet tool install --global dotnet-ef
dotnet add package Microsoft.EntityFrameworkCore.Design


dotnet ef migrations add InitialCreate
dotnet ef database update
---------------------------------------------------------------------------

appssettings:

{
  "ConnectionStrings": {
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=SimbaEventsDb;Trusted_Connection=True;MultipleActiveResultSets=true"
  },
  "Jwt": {
    "Key": "Replace_with_a_very_long_random_secret_at_least_32_chars",
    "Issuer": "simba.events",
    "Audience": "simba.events",
    "DurationInMinutes": "1440"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}

